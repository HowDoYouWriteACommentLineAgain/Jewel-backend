<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Demo</title>
</head>
<body>
  <h1>Product Demo</h1>
  <form action="/api/products" method="POST" id="productForm">
    <div>
      <label for="name">Name</label>
      <input id="name" name="name" type="text" required/>
    </div>
    <div>
      <label for="price">Price</label>
      <input id="price" name="price" type="number" required/>
    </div>
    <div>
      <label for="desc">Description</label>
      <input id="desc" name="description" type="text"/>
    </div>
    <div>
      <label for="img_url">image url</label>
      <input id="img_url" name="image" type="text" />
    </div>
    <input type="submit" id="submitForm" value="Submit">
  </form>
  <button id="getProducts">Get Products</button>
  <ul id="productList"></ul>

  <script>
    const form = document.getElementById('productForm');
    const API_BASE = 'http://localhost:5000/api';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        name: form.name.value,
        price: form.price.value,
        description: form.description.value,
        img_url: form.img_url.value,
      };

      try {
        const res = await fetch(`${API_BASE}/products`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        console.log('Success:', result);
        form.reset();
        getAll();
      } catch (err) {
        console.error(err);
      }
    });
    
    document.getElementById('getProducts').addEventListener('click', ()=> getAll());
    
    async function getAll(){
      try {
        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();
        const ul = document.getElementById('productList');
        ul.innerHTML = '';
        data.forEach(p => {
          
          const img = document.createElement('img'); img.src = p.image; img.alt = p.image;
          const li = document.createElement('li');
          li.textContent = 
            `${p.id} -
            ${p.name} - 
            PHP${p.price} - 
            created at: ${p.created_at} - 
            last modified ${p.modified_at} | `;

          const delButton = document.createElement('INPUT');
          delButton.setAttribute("type", "button"); delButton.style.backgroundColor = "red"; delButton.value = "Delete";
          delButton.addEventListener("click", async() => {
            try {
              const res = await fetch(`${API_BASE}/products/${p.id}`, { method: "DELETE" });
              if (!res.ok) throw new Error(`Failed to delete: ${res.statusText}`);
              console.log(`Deleted product ${p.id}`);
              // refresh the list
              getAll();
            } catch (err) {
              console.error(err);
            }
          });

          const space = document.createElement("span");
          space.innerHTML = " &nbsp; | &nbsp; ";
          li.appendChild(img);
          li.appendChild(space);
          li.appendChild(delButton);
          ul.appendChild(li);
        });
      } catch (err) {
        console.error(err);
      }
    };
  </script>
</body>
</html>